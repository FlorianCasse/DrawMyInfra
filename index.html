<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>InfraLens</title>
<style>
  :root {
    --primary:     #2DC4B8;
    --primary-dk:  #22A89E;
    --brand-dark:  #1C2E44;
    --bg:          #EEF4F8;
    --card:        #FFFFFF;
    --border:      #D0DAE6;
    --text:        #2D3748;
    --muted:       #64748B;
    --drop-hover:  #E3F5F4;
    --input-bg:    #FFFFFF;
    --code-bg:     rgba(0,0,0,.06);
  }
  @media (prefers-color-scheme: dark) {
    :root:not([data-theme="light"]) {
      --brand-dark:  #C8DFF0;
      --bg:          #0C1520;
      --card:        #152030;
      --border:      #243550;
      --text:        #CBD5E0;
      --muted:       #64748B;
      --drop-hover:  #0E2030;
      --input-bg:    #1A2C40;
      --code-bg:     rgba(255,255,255,.08);
    }
  }
  :root[data-theme="dark"] {
    --brand-dark:  #C8DFF0;
    --bg:          #0C1520;
    --card:        #152030;
    --border:      #243550;
    --text:        #CBD5E0;
    --muted:       #64748B;
    --drop-hover:  #0E2030;
    --input-bg:    #1A2C40;
    --code-bg:     rgba(255,255,255,.08);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px 80px;
    transition: background-color .3s, color .3s;
  }
  header { text-align: center; margin-bottom: 40px; }
  .logo-img { height: 180px; width: auto; margin-bottom: 4px; }
  .subtitle { color: var(--muted); font-size: 0.95rem; }
  .card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px;
    width: 100%; max-width: 680px;
    box-shadow: 0 2px 16px rgba(0,0,0,.07);
  }
  .drop-zone {
    border: 2.5px dashed var(--border); border-radius: 12px;
    padding: 40px 24px; text-align: center; cursor: pointer;
    transition: border-color .2s, background .2s;
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--primary); background: var(--drop-hover);
  }
  .drop-icon { font-size: 2.5rem; margin-bottom: 10px; }
  .drop-text { font-size: 1rem; color: var(--muted); }
  .drop-text strong { color: var(--primary); cursor: pointer; }
  #file-input { display: none; }
  #file-list { margin-top: 24px; display: flex; flex-direction: column; gap: 10px; }
  .file-row {
    display: flex; align-items: center; gap: 10px;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px;
  }
  .file-icon { font-size: 1.4rem; }
  .file-name {
    flex: 1; font-size: 0.9rem; font-weight: 600; color: var(--brand-dark);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .site-input {
    border: 1px solid var(--border); border-radius: 6px;
    padding: 4px 10px; font-size: 0.85rem; width: 130px;
    color: var(--text); background: var(--input-bg);
    outline: none; transition: border-color .2s, background .3s;
  }
  .site-input:focus { border-color: var(--primary); }
  .remove-btn {
    background: none; border: none; cursor: pointer;
    font-size: 1.1rem; color: var(--muted); transition: color .15s;
  }
  .remove-btn:hover { color: #e53e3e; }
  #vcf9-option {
    display: flex; align-items: center; gap: 8px;
    margin-top: 18px; font-size: 0.9rem; color: var(--text);
    cursor: pointer; user-select: none;
  }
  #vcf9-option input { accent-color: var(--primary); width: 16px; height: 16px; cursor: pointer; }
  .btn {
    display: block; width: 100%; margin-top: 28px;
    padding: 14px 0; font-size: 1rem; font-weight: 700;
    background: var(--primary); color: #fff;
    border: none; border-radius: 10px; cursor: pointer;
    transition: background .2s, transform .1s; letter-spacing: .3px;
  }
  .btn:hover:not(:disabled) { background: var(--primary-dk); transform: translateY(-1px); }
  .btn:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; transform: none; }
  #status {
    margin-top: 18px; text-align: center;
    font-size: 0.9rem; min-height: 22px;
  }
  .err { color: #e53e3e; }
  .ok  { color: #2d8a4e; font-weight: 600; }
  .spinner {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid var(--border); border-top-color: var(--primary);
    border-radius: 50%; animation: spin .7s linear infinite;
    vertical-align: middle; margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #results-section {
    width: 100%; max-width: 1300px;
    margin-top: 32px;
  }
  .tab-bar {
    display: flex; gap: 4px;
    border-bottom: 2px solid var(--border);
    margin-bottom: 18px;
  }
  .tab-btn {
    background: transparent; border: none;
    border-bottom: 3px solid transparent;
    padding: 10px 20px; font-size: 0.95rem;
    color: var(--muted); cursor: pointer;
    font-family: inherit; transition: color .2s, border-color .2s;
  }
  .tab-btn:hover { color: var(--brand-dark); }
  .tab-btn.active {
    border-bottom-color: var(--primary);
    color: var(--brand-dark); font-weight: 700;
  }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }
  .preview-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .preview-header h2 { font-size: 1.1rem; font-weight: 700; color: var(--brand-dark); }
  .btn-outline {
    padding: 8px 20px; font-size: 0.9rem; font-weight: 600;
    background: transparent; color: var(--primary);
    border: 2px solid var(--primary); border-radius: 8px;
    cursor: pointer; transition: background .2s, color .2s;
  }
  .btn-outline:hover { background: var(--primary); color: #fff; }
  #excalidraw-mount {
    height: 620px; border-radius: 12px; overflow: hidden;
    box-shadow: 0 2px 16px rgba(0,0,0,.10);
    border: 1px solid var(--border);
  }
  footer {
    margin-top: 40px; font-size: 0.8rem; color: var(--muted); text-align: center;
  }
  footer a { color: var(--primary); text-decoration: none; }
  footer code { background: var(--code-bg); padding: 1px 5px; border-radius: 4px; }
  .theme-toggle {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    cursor: pointer; padding: 3px 8px; font-size: 0.85rem;
    color: var(--muted); margin-left: 10px; vertical-align: middle;
    transition: border-color .2s, color .2s;
  }
  .theme-toggle:hover { border-color: var(--primary); color: var(--primary); }

  /* â”€â”€ License Calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #license-option {
    display: flex; align-items: center; gap: 8px;
    margin-top: 10px; font-size: 0.9rem; color: var(--text);
    cursor: pointer; user-select: none;
  }
  #license-option input { accent-color: var(--primary); width: 16px; height: 16px; cursor: pointer; }
  #license-type-wrapper {
    display: inline-flex; align-items: center; gap: 6px; margin-left: 12px;
  }
  #license-type-wrapper select {
    border: 1px solid var(--border); border-radius: 6px;
    padding: 3px 8px; font-size: 0.85rem;
    color: var(--text); background: var(--input-bg);
    outline: none; cursor: pointer;
  }
  .license-summary-box {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 28px;
    margin-bottom: 18px;
    box-shadow: 0 2px 12px rgba(0,0,0,.06);
    display: flex; flex-wrap: wrap; gap: 28px; align-items: center;
  }
  .license-summary-box .summary-item {
    display: flex; flex-direction: column; gap: 2px;
  }
  .license-summary-box .summary-label {
    font-size: 0.78rem; color: var(--muted); text-transform: uppercase; letter-spacing: .5px;
  }
  .license-summary-box .summary-value {
    font-size: 1.3rem; font-weight: 700; color: var(--brand-dark);
  }
  .license-table-wrapper { overflow-x: auto; }
  .license-table {
    width: 100%; border-collapse: collapse;
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden;
    font-size: 0.88rem;
  }
  .license-table th {
    background: var(--primary); color: #fff;
    padding: 10px 14px; text-align: left; font-weight: 600;
    white-space: nowrap;
  }
  .license-table td {
    padding: 8px 14px; border-bottom: 1px solid var(--border);
  }
  .license-table td.num { text-align: right; font-variant-numeric: tabular-nums; }
  .license-table tr:last-child td { border-bottom: none; }
  .license-table tr.totals-row td {
    font-weight: 700; background: var(--bg);
    border-top: 2px solid var(--primary);
  }
  .license-table tr:hover:not(.totals-row) td { background: var(--drop-hover); }
  .license-note {
    margin-top: 14px; font-size: 0.82rem; color: var(--muted);
    line-height: 1.5;
  }
  .license-actions {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 14px;
  }
  .license-actions h2 { font-size: 1.1rem; font-weight: 700; color: var(--brand-dark); flex: 1; }

  /* â”€â”€ VCF9 Readiness Report (reuses license-table / license-summary-box) â”€â”€ */
  .vcf9-compatible  { color: #2d8a4e; }
  .vcf9-incompatible { color: #e53e3e; }
  .vcf9-unknown     { color: #b8860b; }
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="InfraLens" class="logo-img"/>
  <p class="subtitle">Upload <strong>RVTools</strong> or <strong>LiveOptics</strong> .xlsx exports â€” get a ready-to-open infrastructure diagram</p>
</header>

<div class="card">
  <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
    <div class="drop-icon">ðŸ“‚</div>
    <p class="drop-text">Drop your <strong>RVTools</strong> or <strong>LiveOptics</strong> .xlsx files here<br>or <strong>click to browse</strong></p>
  </div>
  <input type="file" id="file-input" accept=".xlsx" multiple/>
  <div id="file-list"></div>
  <label id="vcf9-option">
    <input type="checkbox" id="vcf9-check"/> Check VCF 9 Compatibility (Broadcom Compatibility Guide)
  </label>
  <label id="license-option">
    <input type="checkbox" id="license-check"/> VCF/VVF License Calculator
    <span id="license-type-wrapper">
      <select id="license-type">
        <option value="VCF">VCF (1 TiB/core)</option>
        <option value="VVF">VVF (0.25 TiB/core)</option>
      </select>
    </span>
  </label>
  <button class="btn" id="generate-btn" disabled onclick="generate()">
    Generate Excalidraw Diagram
  </button>
  <div id="status"></div>
</div>

<div id="results-section" hidden>
  <div class="tab-bar" id="tab-bar"></div>

  <div id="tab-diagram" class="tab-panel">
    <div class="preview-header">
      <h2>Diagram Preview</h2>
      <button id="download-btn" class="btn-outline">Download .excalidraw</button>
    </div>
    <div id="excalidraw-mount"></div>
  </div>

  <div id="tab-vcf9" class="tab-panel">
    <div id="vcf9-section">
      <div class="license-actions">
        <h2>VCF 9 Readiness Report</h2>
        <button id="vcf9-txt-btn" class="btn-outline">Download TXT</button>
        <button id="vcf9-csv-btn" class="btn-outline">Download CSV</button>
      </div>
      <div id="vcf9-summary"></div>
      <div class="license-table-wrapper">
        <div id="vcf9-table-container"></div>
      </div>
      <div class="license-note">
        Hosts are checked against the <a href="https://compatibilityguide.broadcom.com/" target="_blank">Broadcom Compatibility Guide</a>.
        Vendor prefixes (Dell, HPE, Lenovo, ...) are stripped before matching.
      </div>
    </div>
  </div>

  <div id="tab-license" class="tab-panel">
    <div id="license-section">
      <div class="license-actions">
        <h2>VCF/VVF License Report</h2>
        <button id="license-txt-btn" class="btn-outline">Download TXT</button>
        <button id="license-csv-btn" class="btn-outline">Download CSV</button>
      </div>
      <div id="license-summary"></div>
      <div class="license-table-wrapper">
        <div id="license-table-container"></div>
      </div>
      <div class="license-note">
        <strong>Note:</strong> vSAN add-on licenses are required when actual vSAN capacity exceeds the entitled TiB.
        This cannot be determined from RVTools/LiveOptics data alone â€” verify against your actual vSAN capacity.
        <br>Formula: Foundation Cores = Sockets Ã— max(Cores per Socket, 16) &nbsp;|&nbsp;
        Ref: <a href="https://knowledge.broadcom.com/external/article?legacyId=313548" target="_blank">KB 313548</a>
      </div>
    </div>
  </div>
</div>

<footer>
  Built with â™¥ by Florian Casse &nbsp;Â·&nbsp;
  Open the generated <code>.excalidraw</code> file at
  <a href="https://excalidraw.com" target="_blank">excalidraw.com</a>
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme"></button>
</footer>

<script>
// â”€â”€ Color palettes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PALETTES = [
  { zone_bg:"#E3F5F4", zone_stroke:"#2DC4B8", hdr_bg:"#2DC4B8", hdr_text:"#FFFFFF",
    cluster_bg:"#EAF8F7", cluster_stroke:"#2DC4B8", host_bg:"#FFFFFF", host_stroke:"#7DD4CE", host_text:"#0D4A45" },
  { zone_bg:"#E8F0FB", zone_stroke:"#1A5DAD", hdr_bg:"#1A5DAD", hdr_text:"#FFFFFF",
    cluster_bg:"#EDF3FD", cluster_stroke:"#1A5DAD", host_bg:"#FFFFFF", host_stroke:"#5B9BD5", host_text:"#0D3B78" },
  { zone_bg:"#E8F5EE", zone_stroke:"#1E8449", hdr_bg:"#1E8449", hdr_text:"#FFFFFF",
    cluster_bg:"#EDF7F1", cluster_stroke:"#1E8449", host_bg:"#FFFFFF", host_stroke:"#52BE80", host_text:"#145A32" },
  { zone_bg:"#EDE8F7", zone_stroke:"#5B3DAB", hdr_bg:"#5B3DAB", hdr_text:"#FFFFFF",
    cluster_bg:"#F3F0FB", cluster_stroke:"#5B3DAB", host_bg:"#FFFFFF", host_stroke:"#9B7DD4", host_text:"#3D2580" },
  { zone_bg:"#EAF0F0", zone_stroke:"#2E7D8C", hdr_bg:"#2E7D8C", hdr_text:"#FFFFFF",
    cluster_bg:"#EEF4F5", cluster_stroke:"#2E7D8C", host_bg:"#FFFFFF", host_stroke:"#6BB8C4", host_text:"#1A4D56" },
  { zone_bg:"#FAE8E8", zone_stroke:"#C0392B", hdr_bg:"#C0392B", hdr_text:"#FFFFFF",
    cluster_bg:"#FDF0F0", cluster_stroke:"#C0392B", host_bg:"#FFFFFF", host_stroke:"#E57373", host_text:"#7B241C" },
];

// â”€â”€ Layout constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ZONE_W    = 780;
const COLS      = 3;
const HOST_W    = 230;
const HOST_H    = 120;
const CLUSTER_H = 28;
const HEADER_H  = 65;
const PAD       = 12;
const COL_GAP   = 10;
const ROW_GAP   = 8;
const ZONE_GAP  = 30;
const CANVAS_X  = 60;
const CANVAS_Y  = 60;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function uid() { return crypto.randomUUID(); }

function findCol(headers, candidates) {
  const map = {};
  headers.forEach(h => map[h.toLowerCase()] = h);
  for (const c of candidates) {
    if (c.toLowerCase() in map) return map[c.toLowerCase()];
  }
  return null;
}

function safe(val) {
  if (val === null || val === undefined) return '';
  return String(val).trim();
}

function fmtPct(v) {
  const f = parseFloat(v);
  if (!isNaN(f)) return `${Math.round(f)}%`;
  return (v && String(v).trim()) ? String(v).trim() : 'â€”';
}

// â”€â”€ VCF 9 Compatibility (Broadcom Compatibility Guide) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _hclCache = null;

async function fetchHcl() {
  if (_hclCache) return _hclCache;
  const res = await fetch('vcf9_hcl.json');
  if (!res.ok) throw new Error('Failed to load VCF 9 compatibility data');
  _hclCache = await res.json();
  return _hclCache;
}

function buildVcf9Lookup(hclData) {
  // Build a Map of normalised model â†’ release list for version-aware lookup
  const models = new Map();
  for (const entry of hclData) {
    models.set(entry.m.trim().toLowerCase(), entry.r);
  }
  return models;
}

function normalizeModel(model) {
  // Strip common vendor prefixes that RVTools sometimes includes
  return model.replace(/^(Dell\s+(Inc\.?\s*)?|HPE?\s+|Lenovo\s+|Cisco\s+|Fujitsu\s+)/i, '').trim();
}

function vcf9Label(releases) {
  const versions = releases.map(r => r.replace(/^ESXi\s*/i, '')).sort();
  return '\u2705 VCF ' + versions.join(' + ') + ' Ready';
}

function checkVcf9Compat(model, lookup) {
  if (!model) return { status: 'unknown', label: '\u26A0\uFE0F VCF9 ?' };
  const norm = normalizeModel(model).toLowerCase();
  // Exact match
  if (lookup.has(norm)) return { status: 'compatible', label: vcf9Label(lookup.get(norm)) };
  // Check if any BCG model is contained in the host model or vice-versa
  for (const [hclModel, releases] of lookup) {
    if (norm.includes(hclModel) || hclModel.includes(norm))
      return { status: 'compatible', label: vcf9Label(releases) };
  }
  return { status: 'incompatible', label: '\u274C Not VCF9 Ready' };
}

let xlsxLoadPromise = null;

function ensureXlsxLoaded() {
  if (window.XLSX) return Promise.resolve(window.XLSX);
  if (xlsxLoadPromise) return xlsxLoadPromise;
  xlsxLoadPromise = new Promise((resolve, reject) => {
    const timeout = setTimeout(() => {
      reject(new Error('Timed out loading XLSX parser â€” check your network connection'));
    }, 15000);
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
    script.async = true;
    script.onload = () => { clearTimeout(timeout); resolve(window.XLSX); };
    script.onerror = () => { clearTimeout(timeout); reject(new Error('Failed to load XLSX parser')); };
    document.head.appendChild(script);
  });
  return xlsxLoadPromise;
}

// â”€â”€ RVTools parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseRvtools(wb, siteName) {
  const sheetMap = {};
  wb.SheetNames.forEach(s => sheetMap[s.toLowerCase()] = s);

  const vhostKey = sheetMap['vhost'];
  if (!vhostKey) throw new Error(`No vHost sheet found in "${siteName}"`);

  const rows = XLSX.utils.sheet_to_json(wb.Sheets[vhostKey], { defval: '' });
  if (!rows.length) throw new Error(`vHost sheet is empty in "${siteName}"`);

  const headers = Object.keys(rows[0]);
  const colHost    = findCol(headers, ['VM Host', 'Host', 'DNS Name', 'Name']);
  const colCluster = findCol(headers, ['Cluster', 'Cluster Name']);
  const colModel   = findCol(headers, ['Model', 'Hardware Model']);
  const colEsxi    = findCol(headers, ['ESX Version', 'ESXi Version', 'Version']);
  const colVms     = findCol(headers, ['# VMs', 'VMs', 'Number of VMs', '#VMs']);
  const colCpu     = findCol(headers, ['CPU usage %', 'CPU %', 'CPU Usage %', 'CPU%']);
  const colMem     = findCol(headers, ['Memory usage %', 'Mem %', 'Memory %', 'Mem%']);
  const colSvc     = findCol(headers, ['Service Tag', 'Serial Number', 'SN']);
  const colSockets     = findCol(headers, ['# CPU', 'CPUs', 'CPU Sockets', 'Sockets', 'Num CPU']);
  const colCoresPerCpu = findCol(headers, ['Cores per CPU', '# Cores per CPU', 'Cores Per Socket']);

  const hosts = [];
  for (const row of rows) {
    const hostname = colHost ? safe(row[colHost]) : '';
    if (!hostname) continue;

    let esxi = colEsxi ? safe(row[colEsxi]) : '';
    const m = esxi.match(/(\d+\.\d+\.\d+)/);
    if (m) esxi = m[1];

    hosts.push({
      hostname,
      cluster:  colCluster ? (safe(row[colCluster]) || 'Default') : 'Default',
      model:    colModel   ? safe(row[colModel])  : '',
      esxi,
      vms:      colVms     ? (safe(row[colVms])   || '0') : '0',
      cpu:      fmtPct(colCpu ? safe(row[colCpu]) : ''),
      mem:      fmtPct(colMem ? safe(row[colMem]) : ''),
      svc:      colSvc     ? safe(row[colSvc])    : '',
      sockets:        colSockets     ? (parseInt(safe(row[colSockets]))     || 0) : 0,
      cores_per_socket: colCoresPerCpu ? (parseInt(safe(row[colCoresPerCpu])) || 0) : 0,
    });
  }

  // vSource â†’ vCenter version
  let vcenterVersion = '';
  const vsKey = sheetMap['vsource'];
  if (vsKey) {
    const vsRows = XLSX.utils.sheet_to_json(wb.Sheets[vsKey], { defval: '' });
    if (vsRows.length) {
      const vsHeaders = Object.keys(vsRows[0]);
      const colFn = findCol(vsHeaders, ['Fullname', 'Full Name', 'Version', 'Name']);
      if (colFn) {
        for (const row of vsRows) {
          const s = safe(row[colFn]);
          let mv = s.match(/vCenter Server\s+(\d+\.\d+\.\d+)/i);
          if (!mv) mv = s.match(/(\d+\.\d+\.\d+\.\d+)/);
          if (mv) { vcenterVersion = mv[1]; break; }
        }
      }
    }
  }

  const clusters = {};
  for (const h of hosts) {
    (clusters[h.cluster] ||= []).push(h);
  }

  return {
    site_name: siteName,
    clusters,
    vcenter_version: vcenterVersion,
    total_hosts: hosts.length,
    total_vms: hosts.reduce((s, h) => s + (parseInt(h.vms) || 0), 0),
  };
}

// â”€â”€ LiveOptics parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseLiveOptics(wb, siteName) {
  const sheetMap = {};
  wb.SheetNames.forEach(s => sheetMap[s.toLowerCase()] = s);

  const hostsKey = sheetMap['esx hosts'];
  if (!hostsKey) throw new Error(`No "ESX Hosts" sheet found in "${siteName}"`);

  const hostsRows = XLSX.utils.sheet_to_json(wb.Sheets[hostsKey], { defval: '' });
  if (!hostsRows.length) throw new Error(`"ESX Hosts" sheet is empty in "${siteName}"`);

  const loHeaders = Object.keys(hostsRows[0]);
  const loColSockets     = findCol(loHeaders, ['CPU Sockets', 'Sockets']);
  const loColCoresPerCpu = findCol(loHeaders, ['Cores Per Socket', 'Cores per CPU']);

  // Build performance lookup: Host Name â†’ perf row
  const perfMap = {};
  const perfKey = sheetMap['esx performance'];
  if (perfKey) {
    for (const row of XLSX.utils.sheet_to_json(wb.Sheets[perfKey], { defval: '' })) {
      const h = safe(row['Host']);
      if (h) perfMap[h] = row;
    }
  }

  // vCenter version from first host row
  let vcenterVersion = '';
  const vcStr = safe(hostsRows[0]['vCenter']);
  const vcMatch = vcStr.match(/(\d+\.\d+\.\d+)/);
  if (vcMatch) vcenterVersion = vcMatch[1];

  const hosts = [];
  for (const row of hostsRows) {
    const hostname = safe(row['Host Name']);
    if (!hostname) continue;

    // ESXi version from OS field e.g. "VMware ESXi 8.0.2 build-23305546"
    let esxi = '';
    const osMatch = safe(row['OS']).match(/(\d+\.\d+\.\d+)/);
    if (osMatch) esxi = osMatch[1];

    const perf = perfMap[hostname] || {};
    hosts.push({
      hostname,
      cluster:  safe(row['Cluster'])       || 'Default',
      model:    safe(row['Model']),
      esxi,
      vms:      safe(row['Guest VM Count']) || '0',
      cpu:      fmtPct(safe(perf['Average CPU %'])),
      mem:      fmtPct(safe(perf['Average Memory %'])),
      svc:      safe(row['Serial No']),
      sockets:        loColSockets     ? (parseInt(safe(row[loColSockets]))     || 0) : 0,
      cores_per_socket: loColCoresPerCpu ? (parseInt(safe(row[loColCoresPerCpu])) || 0) : 0,
    });
  }

  const clusters = {};
  for (const h of hosts) (clusters[h.cluster] ||= []).push(h);

  return {
    site_name: siteName,
    clusters,
    vcenter_version: vcenterVersion,
    total_hosts: hosts.length,
    total_vms: hosts.reduce((s, h) => s + (parseInt(h.vms) || 0), 0),
  };
}

// â”€â”€ Auto-detect format and parse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseFile(arrayBuffer, siteName) {
  const wb = XLSX.read(arrayBuffer, { type: 'array' });
  const lower = wb.SheetNames.map(s => s.toLowerCase());
  if (lower.includes('vhost'))     return parseRvtools(wb, siteName);
  if (lower.includes('esx hosts')) return parseLiveOptics(wb, siteName);
  throw new Error(`"${siteName}" is not a recognised RVTools or LiveOptics export`);
}

// â”€â”€ Excalidraw element builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function randomSeed() { return (Math.random() * 0xFFFFFF) >>> 0; }

function makeRect(id, x, y, w, h, bg, stroke, text = '', fontSize = 12,
                  bold = false, textColor = '#1A1A2E', vAlign = 'middle', rounded = 8) {
  const el = {
    id, type: 'rectangle', x, y, width: w, height: h, angle: 0,
    strokeColor: stroke, backgroundColor: bg, fillStyle: 'solid',
    strokeWidth: 1, strokeStyle: 'solid', roughness: 0, opacity: 100,
    groupIds: [], roundness: { type: 3, value: rounded },
    seed: randomSeed(), version: 1, versionNonce: 0, isDeleted: false,
    boundElements: [], updated: 1, link: null, locked: false,
  };
  const elements = [el];
  if (text) {
    const txtId = uid();
    el.boundElements.push({ type: 'text', id: txtId });
    elements.push({
      id: txtId, type: 'text', x, y, width: w, height: h, angle: 0,
      strokeColor: textColor, backgroundColor: 'transparent',
      fillStyle: 'solid', strokeWidth: 1, strokeStyle: 'solid',
      roughness: 0, opacity: 100, groupIds: [], seed: randomSeed(),
      version: 1, versionNonce: 0, isDeleted: false,
      boundElements: [], updated: 1, link: null, locked: false,
      text,
      fontSize: bold ? fontSize + 1 : fontSize,
      fontFamily: bold ? 1 : 3,
      textAlign: 'center', verticalAlign: vAlign,
      containerId: id, originalText: text, autoResize: true, lineHeight: 1.25,
    });
  }
  return elements;
}

// â”€â”€ Excalidraw diagram generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateExcalidraw(sites, vcf9Enabled) {
  const elements = [];
  let xCursor = CANVAS_X;
  const hostH = vcf9Enabled ? 140 : HOST_H;

  for (let idx = 0; idx < sites.length; idx++) {
    const { site_name, clusters, vcenter_version, total_hosts, total_vms } = sites[idx];
    const p = PALETTES[idx % PALETTES.length];

    // Zone height
    let innerH = HEADER_H + PAD;
    for (const chosts of Object.values(clusters)) {
      innerH += CLUSTER_H + PAD + Math.ceil(chosts.length / COLS) * (hostH + ROW_GAP);
    }
    const zoneH = innerH + PAD;
    const y0 = CANVAS_Y;

    // Site zone background
    elements.push(...makeRect(uid(), xCursor, y0, ZONE_W, zoneH,
      p.zone_bg, p.zone_stroke, '', 12, false, '#1A1A2E', 'middle', 12));

    // Site header
    let hdrText = `${site_name}  Â·  ${total_hosts} hosts  Â·  ${total_vms} VMs`;
    if (vcenter_version) hdrText += `\nvCenter ${vcenter_version}`;
    elements.push(...makeRect(uid(), xCursor, y0, ZONE_W, HEADER_H,
      p.hdr_bg, p.hdr_bg, hdrText, 14, true, p.hdr_text, 'middle', 10));

    // Clusters
    let cy = y0 + HEADER_H + PAD;
    for (const [cname, chosts] of Object.entries(clusters)) {
      elements.push(...makeRect(uid(), xCursor + PAD, cy, ZONE_W - 2*PAD, CLUSTER_H,
        p.cluster_bg, p.cluster_stroke, cname, 11, true, p.zone_stroke, 'middle', 4));
      cy += CLUSTER_H + PAD;

      const rows = Math.ceil(chosts.length / COLS);
      chosts.forEach((h, i) => {
        const hx = xCursor + PAD + (i % COLS) * (HOST_W + COL_GAP);
        const hy = cy + Math.floor(i / COLS) * (hostH + ROW_GAP);
        const lines = [
          h.hostname,
          h.model || 'â€”',
          h.svc ? `SVC: ${h.svc}` : 'SVC: â€”',
          h.esxi ? `ESXi ${h.esxi}` : 'ESXi â€”',
          `VMs:${h.vms}  CPU:${h.cpu}  Mem:${h.mem}`,
        ];
        if (vcf9Enabled && h.vcf9) lines.push(h.vcf9.label);
        const label = lines.join('\n');

        const stroke = (vcf9Enabled && h.vcf9 && h.vcf9.status === 'incompatible')
          ? '#E57373' : p.host_stroke;
        elements.push(...makeRect(uid(), hx, hy, HOST_W, hostH,
          p.host_bg, stroke, label, 9, false, p.host_text, 'middle', 6));
      });

      cy += rows * (hostH + ROW_GAP) + PAD;
    }

    xCursor += ZONE_W + ZONE_GAP;
  }

  // VCF9 legend
  if (vcf9Enabled) {
    const legendX = xCursor;
    const legendY = CANVAS_Y;
    const legendW = 220;
    const legendH = 90;
    const legendText = 'VCF 9 Compatibility\n\u2705 VCF x.x Ready\n\u274C Not VCF9 Ready\n\u26A0\uFE0F VCF9 ? â€” model unknown';
    elements.push(...makeRect(uid(), legendX, legendY, legendW, legendH,
      '#FFF9E6', '#D4A017', legendText, 9, false, '#4A4A00', 'middle', 8));
  }

  return { type: 'excalidraw', version: 2, source: 'https://excalidraw.com',
           elements, appState: { gridSize: null, viewBackgroundColor: '#F4F5F7' }, files: {} };
}

// â”€â”€ UI logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dropZone  = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileList  = document.getElementById('file-list');
const genBtn    = document.getElementById('generate-btn');
const status    = document.getElementById('status');

let files = [];

function setStatus(text, type) {
  status.innerHTML = '';
  if (type === 'loading') {
    const spinner = document.createElement('span');
    spinner.className = 'spinner';
    status.appendChild(spinner);
    status.appendChild(document.createTextNode(' ' + text));
  } else if (type) {
    const span = document.createElement('span');
    span.className = type;
    span.textContent = text;
    status.appendChild(span);
  } else {
    status.textContent = text;
  }
}

function guessName(filename) {
  return filename.replace(/\.xlsx$/i, '').replace(/[_-]/g, ' ').trim();
}

function renderList() {
  fileList.innerHTML = '';
  files.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'file-row';

    const icon = document.createElement('span');
    icon.className = 'file-icon';
    icon.textContent = 'ðŸ“„';

    const name = document.createElement('span');
    name.className = 'file-name';
    name.title = item.file.name;
    name.textContent = item.file.name;

    const input = document.createElement('input');
    input.className = 'site-input';
    input.type = 'text';
    input.value = item.name;
    input.placeholder = 'Site name';
    input.addEventListener('input', () => { files[i].name = input.value; });

    const btn = document.createElement('button');
    btn.className = 'remove-btn';
    btn.title = 'Remove';
    btn.textContent = 'âœ•';
    btn.addEventListener('click', () => removeFile(i));

    row.append(icon, name, input, btn);
    fileList.appendChild(row);
  });
  genBtn.disabled = files.length === 0;
}

function addFiles(newFiles) {
  for (const f of newFiles) {
    if (f.name.endsWith('.xlsx') && !files.find(x => x.file.name === f.name))
      files.push({ file: f, name: guessName(f.name) });
  }
  renderList();
  status.textContent = '';
}

function removeFile(i) { files.splice(i, 1); renderList(); }

fileInput.addEventListener('change', () => addFiles(fileInput.files));
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag-over'); addFiles(e.dataTransfer.files);
});

function readFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
    reader.readAsArrayBuffer(file);
  });
}

// â”€â”€ Theme toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function () {
  const root    = document.documentElement;
  const btn     = document.getElementById('theme-toggle');
  const mq      = window.matchMedia('(prefers-color-scheme: dark)');

  function activeTheme() {
    const explicit = root.getAttribute('data-theme');
    if (explicit) return explicit;
    return mq.matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    root.setAttribute('data-theme', theme);
    btn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    document.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme } }));
  }

  // Restore saved preference, or follow system
  const saved = localStorage.getItem('dmi-theme');
  if (saved) {
    applyTheme(saved);
  } else {
    btn.textContent = mq.matches ? 'â˜€ï¸' : 'ðŸŒ™';
  }

  btn.addEventListener('click', () => {
    const next = activeTheme() === 'dark' ? 'light' : 'dark';
    localStorage.setItem('dmi-theme', next);
    applyTheme(next);
  });

  // Track system changes when no explicit override is saved
  mq.addEventListener('change', () => {
    if (!localStorage.getItem('dmi-theme')) {
      btn.textContent = mq.matches ? 'â˜€ï¸' : 'ðŸŒ™';
      document.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme: activeTheme() } }));
    }
  });
})();

// â”€â”€ License Calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calculateLicensing(sites, deploymentType) {
  const tibPerCore = deploymentType === 'VCF' ? 1 : 0.25;
  const rows = [];
  let totalCores = 0, totalTib = 0, missingCount = 0;

  for (const site of sites) {
    for (const [cluster, hosts] of Object.entries(site.clusters)) {
      for (const h of hosts) {
        const sockets = h.sockets || 0;
        const coresPerSocket = h.cores_per_socket || 0;

        if (sockets === 0 || coresPerSocket === 0) {
          missingCount++;
          rows.push({
            site: site.site_name, cluster, hostname: h.hostname,
            sockets, coresPerSocket,
            foundationCores: 0, entitledTib: 0, missing: true,
          });
          continue;
        }

        const effectiveCores = Math.max(coresPerSocket, 16);
        const foundationCores = sockets * effectiveCores;
        const entitledTib = foundationCores * tibPerCore;

        totalCores += foundationCores;
        totalTib += entitledTib;

        rows.push({
          site: site.site_name, cluster, hostname: h.hostname,
          sockets, coresPerSocket,
          foundationCores, entitledTib, missing: false,
        });
      }
    }
  }

  return { rows, totalCores, totalTib, missingCount, deploymentType, tibPerCore };
}

function renderLicenseReport() {
  const report = window.__licenseReport;
  if (!report) return;

  // Summary
  const summary = document.getElementById('license-summary');
  let warningHtml = '';
  if (report.missingCount > 0) {
    warningHtml = `<div class="summary-item"><span class="summary-label">Missing Data</span><span class="summary-value" style="color:#e53e3e">${report.missingCount} host(s)</span></div>`;
  }
  summary.innerHTML = `<div class="license-summary-box">
    <div class="summary-item"><span class="summary-label">Deployment</span><span class="summary-value">${report.deploymentType}</span></div>
    <div class="summary-item"><span class="summary-label">Total Foundation Cores</span><span class="summary-value">${report.totalCores.toLocaleString()}</span></div>
    <div class="summary-item"><span class="summary-label">vSAN Entitled TiB</span><span class="summary-value">${report.totalTib.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></div>
    <div class="summary-item"><span class="summary-label">TiB per Core</span><span class="summary-value">${report.tibPerCore}</span></div>
    ${warningHtml}
  </div>`;

  // Table
  const container = document.getElementById('license-table-container');
  let html = `<table class="license-table">
    <thead><tr>
      <th>Site</th><th>Cluster</th><th>Hostname</th>
      <th>Sockets</th><th>Cores/Socket</th>
      <th>Foundation Cores</th><th>Entitled TiB</th>
    </tr></thead><tbody>`;

  for (const r of report.rows) {
    const cls = r.missing ? ' style="color:#e53e3e;font-style:italic"' : '';
    html += `<tr${cls}>
      <td>${r.site}</td><td>${r.cluster}</td><td>${r.hostname}</td>
      <td class="num">${r.sockets || 'â€”'}</td>
      <td class="num">${r.coresPerSocket || 'â€”'}</td>
      <td class="num">${r.missing ? 'â€”' : r.foundationCores}</td>
      <td class="num">${r.missing ? 'â€”' : r.entitledTib.toFixed(2)}</td>
    </tr>`;
  }

  html += `<tr class="totals-row">
    <td colspan="5"><strong>Total</strong></td>
    <td class="num">${report.totalCores.toLocaleString()}</td>
    <td class="num">${report.totalTib.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
  </tr></tbody></table>`;
  container.innerHTML = html;
}

// â”€â”€ VCF 9 Readiness Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildVcf9Report(sites) {
  const rows = [];
  let compatible = 0, incompatible = 0, unknown = 0;

  for (const site of sites) {
    for (const [cluster, hosts] of Object.entries(site.clusters)) {
      for (const h of hosts) {
        const vcf9 = h.vcf9 || { status: 'unknown', label: 'N/A' };
        rows.push({
          site: site.site_name, cluster, hostname: h.hostname,
          model: h.model || '', esxi: h.esxi || '',
          status: vcf9.status, label: vcf9.label,
        });
        if (vcf9.status === 'compatible') compatible++;
        else if (vcf9.status === 'incompatible') incompatible++;
        else unknown++;
      }
    }
  }

  return { rows, compatible, incompatible, unknown, total: rows.length };
}

function renderVcf9Report() {
  const report = window.__vcf9Report;
  if (!report) return;

  // Summary
  const summary = document.getElementById('vcf9-summary');
  summary.innerHTML = `<div class="license-summary-box">
    <div class="summary-item"><span class="summary-label">Total Hosts</span><span class="summary-value">${report.total}</span></div>
    <div class="summary-item"><span class="summary-label">Compatible</span><span class="summary-value vcf9-compatible">${report.compatible}</span></div>
    <div class="summary-item"><span class="summary-label">Not Compatible</span><span class="summary-value vcf9-incompatible">${report.incompatible}</span></div>
    <div class="summary-item"><span class="summary-label">Unknown</span><span class="summary-value vcf9-unknown">${report.unknown}</span></div>
  </div>`;

  // Table
  const container = document.getElementById('vcf9-table-container');
  let html = `<table class="license-table">
    <thead><tr>
      <th>Site</th><th>Cluster</th><th>Hostname</th>
      <th>Model</th><th>ESXi</th><th>VCF 9 Status</th>
    </tr></thead><tbody>`;

  for (const r of report.rows) {
    const cls = r.status === 'compatible' ? 'vcf9-compatible'
              : r.status === 'incompatible' ? 'vcf9-incompatible' : 'vcf9-unknown';
    html += `<tr>
      <td>${r.site}</td><td>${r.cluster}</td><td>${r.hostname}</td>
      <td>${r.model || 'â€”'}</td><td>${r.esxi || 'â€”'}</td>
      <td class="${cls}">${r.label}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  container.innerHTML = html;
}

function generateVcf9Txt(report) {
  const hdrs = ['SITE', 'CLUSTER', 'HOSTNAME', 'MODEL', 'ESXI_VERSION', 'VCF9_STATUS'];
  const cols = hdrs.map(h => h.length);
  for (const r of report.rows) {
    cols[0] = Math.max(cols[0], r.site.length);
    cols[1] = Math.max(cols[1], r.cluster.length);
    cols[2] = Math.max(cols[2], r.hostname.length);
    cols[3] = Math.max(cols[3], (r.model || '').length);
    cols[4] = Math.max(cols[4], (r.esxi || '').length);
    cols[5] = Math.max(cols[5], r.label.length);
  }

  const pad = (s, w) => String(s).padEnd(w);
  const hdrLine = hdrs.map((h, i) => pad(h, cols[i])).join(' ');
  const sep = cols.map(w => '-'.repeat(w)).join(' ');

  const lines = [
    'VCF 9 Readiness Report',
    '',
    `Total: ${report.total}  |  Compatible: ${report.compatible}  |  Not Compatible: ${report.incompatible}  |  Unknown: ${report.unknown}`,
    '',
    hdrLine,
    sep,
  ];

  for (const r of report.rows) {
    lines.push([
      pad(r.site, cols[0]),
      pad(r.cluster, cols[1]),
      pad(r.hostname, cols[2]),
      pad(r.model || '', cols[3]),
      pad(r.esxi || '', cols[4]),
      pad(r.label, cols[5]),
    ].join(' '));
  }
  lines.push('');
  return lines.join('\n');
}

function generateVcf9Csv(report) {
  const lines = ['Site,Cluster,Hostname,Model,ESXi Version,VCF9 Status'];
  for (const r of report.rows) {
    lines.push([r.site, r.cluster, r.hostname, r.model, r.esxi, r.label]
      .map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));
  }
  return lines.join('\n');
}

document.getElementById('vcf9-txt-btn').addEventListener('click', () => {
  const report = window.__vcf9Report;
  if (!report) return;
  const txt = generateVcf9Txt(report);
  const blob = new Blob([txt], { type: 'text/plain' });
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob), download: 'vcf9_readiness_report.txt',
  });
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('vcf9-csv-btn').addEventListener('click', () => {
  const report = window.__vcf9Report;
  if (!report) return;
  const csv = generateVcf9Csv(report);
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob), download: 'vcf9_readiness_report.csv',
  });
  a.click();
  URL.revokeObjectURL(a.href);
});

function generateLicenseTxt(report) {
  const dt = report.deploymentType;
  const fullName = dt === 'VCF' ? 'VMware Cloud Foundation (VCF) Instance' : 'VMware vSphere Foundation (VVF)';

  // Compute column widths dynamically
  const hdrs = ['CLUSTER', 'VMHOST', 'NUM_CPU_SOCKETS', 'NUM_CPU_CORES_PER_SOCKET', 'FOUNDATION_LICENSE_CORE_COUNT', 'VSAN_LICENSE_TIB_COUNT'];
  const cols = hdrs.map(h => h.length);
  for (const r of report.rows) {
    cols[0] = Math.max(cols[0], (r.cluster || '').length);
    cols[1] = Math.max(cols[1], (r.hostname || '').length);
    cols[2] = Math.max(cols[2], String(r.sockets).length);
    cols[3] = Math.max(cols[3], String(r.coresPerSocket).length);
    cols[4] = Math.max(cols[4], String(r.missing ? '-' : r.foundationCores).length);
    cols[5] = Math.max(cols[5], (r.missing ? '-' : r.entitledTib.toFixed(2)).length);
  }
  cols[4] = Math.max(cols[4], String(report.totalCores).length);
  cols[5] = Math.max(cols[5], report.totalTib.toFixed(2).length);
  // 'Total' row
  cols[0] = Math.max(cols[0], 5);

  const pad = (s, w, right) => right ? String(s).padStart(w) : String(s).padEnd(w);
  const sep = cols.map(w => '-'.repeat(w)).join(' ');
  const hdrLine = hdrs.map((h, i) => i < 2 ? pad(h, cols[i], false) : pad(h, cols[i], true)).join(' ');

  const lines = [];
  lines.push(`Sizing Results for ${fullName}:`);
  lines.push('');
  lines.push('Host Information');
  lines.push('');
  lines.push(hdrLine);
  lines.push(sep);

  for (const r of report.rows) {
    const fc = r.missing ? '-' : String(r.foundationCores);
    const tib = r.missing ? '-' : r.entitledTib.toFixed(2);
    lines.push([
      pad(r.cluster || '', cols[0], false),
      pad(r.hostname || '', cols[1], false),
      pad(r.missing ? '-' : r.sockets, cols[2], true),
      pad(r.missing ? '-' : r.coresPerSocket, cols[3], true),
      pad(fc, cols[4], true),
      pad(tib, cols[5], true),
    ].join(' '));
  }

  // Total row
  lines.push([
    pad('Total', cols[0], false),
    pad('-', cols[1], false),
    pad('-', cols[2], true),
    pad('-', cols[3], true),
    pad(String(report.totalCores), cols[4], true),
    pad(report.totalTib.toFixed(2), cols[5], true),
  ].join(' '));

  // Cluster Information â€” aggregate entitled TiB per cluster
  lines.push('');
  lines.push('Cluster Information');
  lines.push('');

  const clusterTib = {};
  for (const r of report.rows) {
    if (!r.missing) {
      clusterTib[r.cluster] = (clusterTib[r.cluster] || 0) + r.entitledTib;
    }
  }
  const cHdr = 'CLUSTER';
  const tHdr = 'VSAN_ENTITLED_TIB';
  const cw0 = Math.max(cHdr.length, ...Object.keys(clusterTib).map(k => k.length), 5);
  const cw1 = Math.max(tHdr.length, ...Object.values(clusterTib).map(v => v.toFixed(2).length), report.totalTib.toFixed(2).length);
  lines.push(pad(cHdr, cw0, false) + ' ' + pad(tHdr, cw1, true));
  lines.push('-'.repeat(cw0) + ' ' + '-'.repeat(cw1));
  let clusterTibTotal = 0;
  for (const [name, tib] of Object.entries(clusterTib)) {
    lines.push(pad(name, cw0, false) + ' ' + pad(tib.toFixed(2), cw1, true));
    clusterTibTotal += tib;
  }
  lines.push(pad('Total', cw0, false) + ' ' + pad(clusterTibTotal.toFixed(2), cw1, true));

  lines.push('');
  lines.push(`Total Required ${dt} Compute Licenses: ${report.totalCores}`);
  lines.push(`Total Required vSAN Add-on Licenses: N/A (requires actual vSAN capacity data)`);
  lines.push('');

  return lines.join('\n');
}

document.getElementById('license-txt-btn').addEventListener('click', () => {
  const report = window.__licenseReport;
  if (!report) return;
  const txt = generateLicenseTxt(report);
  const blob = new Blob([txt], { type: 'text/plain' });
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob),
    download: `license_report_${report.deploymentType}.txt`,
  });
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('license-csv-btn').addEventListener('click', () => {
  const report = window.__licenseReport;
  if (!report) return;
  const lines = ['Site,Cluster,Hostname,Sockets,Cores per Socket,Foundation Cores,Entitled TiB'];
  for (const r of report.rows) {
    lines.push([r.site, r.cluster, r.hostname, r.sockets, r.coresPerSocket,
      r.missing ? '' : r.foundationCores,
      r.missing ? '' : r.entitledTib.toFixed(2)].map(v => `"${v}"`).join(','));
  }
  lines.push(['Total','','','','',report.totalCores,report.totalTib.toFixed(2)].map(v => `"${v}"`).join(','));
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob),
    download: `license_report_${report.deploymentType}.csv`,
  });
  a.click();
  URL.revokeObjectURL(a.href);
});

// â”€â”€ Tab system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTabBar(hasVcf9, hasLicense) {
  const bar = document.getElementById('tab-bar');
  bar.innerHTML = '';
  const tabs = [{ id: 'tab-diagram', label: 'Diagram' }];
  if (hasVcf9) tabs.push({ id: 'tab-vcf9', label: 'VCF 9 Readiness' });
  if (hasLicense) tabs.push({ id: 'tab-license', label: 'License Report' });

  tabs.forEach((t, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i === 0 ? ' active' : '');
    btn.textContent = t.label;
    btn.setAttribute('data-tab', t.id);
    btn.addEventListener('click', () => switchTab(t.id));
    bar.appendChild(btn);
  });

  // Show/hide panels, activate first
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(tabs[0].id).classList.add('active');
}

function switchTab(panelId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${panelId}"]`);
  if (btn) btn.classList.add('active');
  document.getElementById(panelId).classList.add('active');
  if (panelId === 'tab-diagram' && window.renderDiagram) window.renderDiagram().catch(() => {});
}

async function generate() {
  if (!files.length) return;
  genBtn.disabled = true;
  setStatus('Generating diagramâ€¦', 'loading');

  try {
    await ensureXlsxLoaded();
    const sites = [];
    for (const item of files) {
      const buf = await readFile(item.file);
      sites.push(parseFile(buf, item.name || item.file.name));
    }

    const vcf9Enabled = document.getElementById('vcf9-check').checked;
    let vcf9Lookup = null;
    if (vcf9Enabled) {
      try {
        setStatus('Loading VCF 9 compatibility dataâ€¦', 'loading');
        const hclData = await fetchHcl();
        vcf9Lookup = buildVcf9Lookup(hclData);
      } catch (e) {
        setStatus('Warning: Could not load VCF 9 data â€” continuing without VCF9 check', 'err');
        vcf9Lookup = null;
      }
    }

    if (vcf9Enabled && vcf9Lookup) {
      for (const site of sites) {
        for (const chosts of Object.values(site.clusters)) {
          for (const h of chosts) {
            h.vcf9 = checkVcf9Compat(h.model, vcf9Lookup);
          }
        }
      }
    }

    const doc = generateExcalidraw(sites, vcf9Enabled && !!vcf9Lookup);
    window.__excalidrawDoc = doc;

    // VCF 9 Readiness Report
    const hasVcf9 = vcf9Enabled && !!vcf9Lookup;
    if (hasVcf9) {
      window.__vcf9Report = buildVcf9Report(sites);
      renderVcf9Report();
    } else {
      window.__vcf9Report = null;
    }

    // License Calculator
    const licenseEnabled = document.getElementById('license-check').checked;
    if (licenseEnabled) {
      const deploymentType = document.getElementById('license-type').value;
      window.__licenseReport = calculateLicensing(sites, deploymentType);
      renderLicenseReport();
    } else {
      window.__licenseReport = null;
    }

    // Build tab bar and show results
    buildTabBar(hasVcf9, licenseEnabled);
    const resultsSection = document.getElementById('results-section');
    resultsSection.hidden = false;
    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Trigger diagram render
    document.dispatchEvent(new CustomEvent('diagram-ready'));

    setStatus('âœ“ Diagram ready â€” see preview below', 'ok');
  } catch (e) {
    setStatus('Error: ' + e.message, 'err');
  } finally {
    genBtn.disabled = false;
  }
}
</script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19",
    "react/jsx-runtime": "https://esm.sh/react@19/jsx-runtime",
    "react-dom": "https://esm.sh/react-dom@19",
    "react-dom/client": "https://esm.sh/react-dom@19/client"
  }
}
</script>
<script type="module">
let root = null;
let excalidrawLoadPromise = null;
let ReactLib = null;
let createRootFn = null;
let ExcalidrawLib = null;

function ensureExcalidrawStyles() {
  if (document.querySelector('link[data-excalidraw-css="true"]')) return;
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = 'https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/dev/index.css';
  link.setAttribute('data-excalidraw-css', 'true');
  document.head.appendChild(link);
}

async function ensureExcalidrawLoaded() {
  if (ExcalidrawLib && ReactLib && createRootFn) return;
  if (excalidrawLoadPromise) {
    await excalidrawLoadPromise;
    return;
  }

  excalidrawLoadPromise = Promise.race([
    (async () => {
      window.EXCALIDRAW_ASSET_PATH = 'https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/prod/';
      ensureExcalidrawStyles();
      const [reactMod, reactDomMod, excalidrawMod] = await Promise.all([
        import('react'),
        import('react-dom/client'),
        import('https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/dev/index.js?external=react,react-dom'),
      ]);
      ReactLib = reactMod.default;
      createRootFn = reactDomMod.createRoot;
      ExcalidrawLib = excalidrawMod;
    })(),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Timed out loading Excalidraw â€” check your network connection')), 20000)
    ),
  ]);

  await excalidrawLoadPromise;
}

function excalidrawTheme() {
  return document.documentElement.getAttribute('data-theme') === 'dark' ||
    (!document.documentElement.getAttribute('data-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ? 'dark' : 'light';
}

async function renderDiagram() {
  const doc = window.__excalidrawDoc;
  if (!doc) return;
  await ensureExcalidrawLoaded();
  const mount = document.getElementById('excalidraw-mount');
  if (root) root.unmount();
  root = createRootFn(mount);
  root.render(ReactLib.createElement(ExcalidrawLib.Excalidraw, {
    initialData: { elements: doc.elements, appState: doc.appState, scrollToContent: true },
    viewModeEnabled: true,
    theme: excalidrawTheme(),
  }));
}
window.renderDiagram = renderDiagram;

document.addEventListener('diagram-ready', () => {
  renderDiagram().catch((e) => {
    setStatus('Error loading preview: ' + e.message, 'err');
  });
});

document.addEventListener('theme-changed', () => {
  renderDiagram().catch(() => {});
});

document.getElementById('download-btn').addEventListener('click', () => {
  const doc = window.__excalidrawDoc;
  if (!doc) return;
  const blob = new Blob([JSON.stringify(doc, null, 2)], { type: 'application/json' });
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob),
    download: 'vmware_infrastructure.excalidraw',
  });
  a.click();
  URL.revokeObjectURL(a.href);
});
</script>
</body>
</html>
